select `totals`.`user_id` AS `user_id`,`totals`.`badge_id` AS `badge_id`,`totals`.`total_points` AS `total_points`,ifnull((case when ((`totals`.`level10_points` is not null) and (`totals`.`total_points` >= `totals`.`level10_points`)) then 0 when ((`totals`.`level9_points` is not null) and (`totals`.`total_points` >= `totals`.`level9_points`)) then (`totals`.`level10_points` - `totals`.`total_points`) when ((`totals`.`level8_points` is not null) and (`totals`.`total_points` >= `totals`.`level8_points`)) then (`totals`.`level9_points` - `totals`.`total_points`) when ((`totals`.`level7_points` is not null) and (`totals`.`total_points` >= `totals`.`level7_points`)) then (`totals`.`level8_points` - `totals`.`total_points`) when ((`totals`.`level6_points` is not null) and (`totals`.`total_points` >= `totals`.`level6_points`)) then (`totals`.`level7_points` - `totals`.`total_points`) when ((`totals`.`level5_points` is not null) and (`totals`.`total_points` >= `totals`.`level5_points`)) then (`totals`.`level6_points` - `totals`.`total_points`) when ((`totals`.`level4_points` is not null) and (`totals`.`total_points` >= `totals`.`level4_points`)) then (`totals`.`level5_points` - `totals`.`total_points`) when ((`totals`.`level3_points` is not null) and (`totals`.`total_points` >= `totals`.`level3_points`)) then (`totals`.`level4_points` - `totals`.`total_points`) when ((`totals`.`level2_points` is not null) and (`totals`.`total_points` >= `totals`.`level2_points`)) then (`totals`.`level3_points` - `totals`.`total_points`) when ((`totals`.`level1_points` is not null) and (`totals`.`total_points` >= `totals`.`level1_points`)) then (`totals`.`level2_points` - `totals`.`total_points`) else (`totals`.`level1_points` - `totals`.`total_points`) end),0) AS `to_next_level`,(case when ((`totals`.`level10_points` is not null) and (`totals`.`total_points` >= `totals`.`level10_points`)) then 10 when ((`totals`.`level9_points` is not null) and (`totals`.`total_points` >= `totals`.`level9_points`)) then 9 when ((`totals`.`level8_points` is not null) and (`totals`.`total_points` >= `totals`.`level8_points`)) then 8 when ((`totals`.`level7_points` is not null) and (`totals`.`total_points` >= `totals`.`level7_points`)) then 7 when ((`totals`.`level6_points` is not null) and (`totals`.`total_points` >= `totals`.`level6_points`)) then 6 when ((`totals`.`level5_points` is not null) and (`totals`.`total_points` >= `totals`.`level5_points`)) then 5 when ((`totals`.`level4_points` is not null) and (`totals`.`total_points` >= `totals`.`level4_points`)) then 4 when ((`totals`.`level3_points` is not null) and (`totals`.`total_points` >= `totals`.`level3_points`)) then 3 when ((`totals`.`level2_points` is not null) and (`totals`.`total_points` >= `totals`.`level2_points`)) then 2 when ((`totals`.`level1_points` is not null) and (`totals`.`total_points` >= `totals`.`level1_points`)) then 1 else 0 end) AS `current_level` from (select `u`.`user_id` AS `user_id`,`b`.`badge_id` AS `badge_id`,`b`.`level10_points` AS `level10_points`,`b`.`level9_points` AS `level9_points`,`b`.`level8_points` AS `level8_points`,`b`.`level7_points` AS `level7_points`,`b`.`level6_points` AS `level6_points`,`b`.`level5_points` AS `level5_points`,`b`.`level4_points` AS `level4_points`,`b`.`level3_points` AS `level3_points`,`b`.`level2_points` AS `level2_points`,`b`.`level1_points` AS `level1_points`,sum((case when 
(
   (
       (date_format(curdate(),'%m%d') < date_format(`rd`.`reset_date`,'%m%d')) and (concat(date_format((curdate() - interval 1 year),'%Y'),date_format(`rd`.`reset_date`,'%m%d')) <= date_format(`us`.`log_date`,'%Y%m%d')) and (concat(date_format(curdate(),'%Y'),date_format(`rd`.`reset_date`,'%m%d')) > date_format(`us`.`log_date`,'%Y%m%d'))) or ((date_format(curdate(),'%m%d') >= date_format(`rd`.`reset_date`,'%m%d')) and (concat(date_format(curdate(),'%Y'),date_format(`rd`.`reset_date`,'%m%d')) <= date_format(`us`.`log_date`,'%Y%m%d')))) then `s`.`points` else 0 end)) AS `total_points` from (((`devmed`.`users` `u` join `devmed`.`badges` `b`) left join (`devmed`.`user_stamps` `us` join `devmed`.`stamps` `s` on((`us`.`stamp_id` = `s`.`stamp_id`))) on(((`u`.`user_id` = `us`.`user_id`) and (`b`.`badge_id` = `s`.`badge_id`)))) join `devmed`.`reset_date` `rd`) group by `u`.`user_id`,`b`.`badge_id`,`b`.`level1_points`,`b`.`level2_points`,`b`.`level3_points`,`b`.`level4_points`,`b`.`level5_points`,`b`.`level6_points`,`b`.`level7_points`,`b`.`level8_points`,`b`.`level9_points`,`b`.`level10_points`) `totals`